"use strict";var I=Object.create;var j=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var G=(e,n)=>{for(var t in n)j(e,t,{get:n[t],enumerable:!0})},R=(e,n,t,o)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of B(n))!z.call(e,s)&&s!==t&&j(e,s,{get:()=>n[s],enumerable:!(o=q(n,s))||o.enumerable});return e};var C=(e,n,t)=>(t=e!=null?I(J(e)):{},R(n||!e||!e.__esModule?j(t,"default",{value:e,enumerable:!0}):t,e)),T=e=>R(j({},"__esModule",{value:!0}),e);var H={};G(H,{default:()=>U,mapPrismaToDb:()=>_,parseDatamodel:()=>k});module.exports=T(H);var d=C(require("path")),F=C(require("child_process")),p=C(require("fs")),v=C(require("os")),P=C(require("dotenv"));P.config();function A(e){let n=e.indexOf('"datamodel"'),t=e.indexOf("{",n),o=0,s=t;for(;s<e.length;){let f=e[s++];if(f==="{")o++;else if(f==="}"&&(o--,o===0))break}return e.slice(t,s)}async function k(e,n,t){let o=d.resolve(d.join(t,"schema.prisma"));p.default.writeFileSync(o,n);let s=await new Promise((f,$)=>{let m=F.exec(`"${e}" --datamodel-path="${o}" cli dmmf`),y="";m.stderr?.on("data",g=>{g.includes("error:")&&$(g.slice(g.indexOf("error:"),g.indexOf("\\n")))}),m.stdout?.on("data",g=>{y+=g}),m.on("exit",()=>{f(y)})});return A(s)}function W(e,n){let{tableOnly:t=!1,ignoreEnums:o=!1,includeRelationFromFields:s=!1,disableEmoji:f=!1}=n??{},$="erDiagram",m=e.models.concat(e.types),y=t||o?"":e.enums.map(l=>`
        ${l.dbName||l.name} {
            ${l.values.map(i=>`${i.name||i.dbName} ${i.dbName||i.name}`).join(`
`)}
        }
    `).join(`

`),g=f?'"PK"':'"\u{1F5DD}\uFE0F"',b=f?'"nullable"':'"\u2753"',O=m.map(l=>`  "${l.dbName||l.name}" {
${t?"":l.fields.filter(K(l,s)).map(i=>`    ${i.type.trimStart()} ${i.name.replace(/^_/,"z_")} ${i.isId||l.primaryKey?.fields?.includes(i.name)?g:""}${i.isRequired?"":b}`).join(`
`)}
    }
  `).join(`

`),x="";for(let l of m)for(let i of l.fields){let h=i.kind==="enum";if(h&&(t||o))continue;let S=`${h?"enum:":""}${i.name}`,E=`"${l.dbName||l.name}"`,w=`"${m.find(a=>a.name===i.type)?.dbName||i.type}"`;if(i.relationFromFields&&i.relationFromFields.length>0||h){let a="||";i.isList?a="}o":i.isRequired||(a="|o");let c=m.find(r=>r.name===w),u=c?.fields.find(({relationName:r})=>r===i.relationName),M=a;u?.isList?a="o{":u?.isRequired||(a="o|"),x+=`    ${E} ${a}--${M} ${c?.dbName||w} : "${S}"
`}else if(m.find(a=>a.name===i.type||a.dbName===i.type)&&i.relationFromFields?.length===0){let a=m.find(c=>c.name===i.type||c.dbName===i.type);if(a){let c=m.indexOf(l),u=m.indexOf(a);c<u&&(x+=`    ${E} o{--}o ${w} : ""
`)}}else if(i.kind==="object"){let a=e.types.find(c=>c.name.replace(/^_/,"z_").replace(/\s/g,""));if(console.log(w,a),a){let c="||";i.isList?c="}o":i.isRequired||(c="|o");let u=a?.fields.find(({relationName:r})=>r===i.relationName),M=c;u?.isList?c="o{":u?.isRequired||(c="o|"),x+=`    ${E} ${c}--${M} ${a.dbName||w} : "${S}"
`}}}return`${$}
${y}
${O}
${x}`}var K=(e,n)=>t=>n?t.kind!=="object":t.kind!=="object"&&!e.fields.find(({relationFromFields:o})=>o?.includes(t.name)),_=(e,n)=>{let t=n?.split(`
`).filter(o=>o.includes("@map")||o.includes("model ")).map(o=>o.trim());return e.map(o=>({...o,fields:o.fields.map(s=>{let f="None",$=t.filter(m=>(f==="Match"&&m.includes("model ")&&(f="End"),f==="None"&&m.includes(`model ${o.name} `)&&(f="Match"),f==="Match")).find(m=>m.includes(`${s.name} `)&&m.includes("@map"));if($){let y=new RegExp(/@map\(\"(.*?)\"\)/,"g").exec($);if(y?.[1]){let g=y[1].replace(/^_/,"z_").replace(/\s/g,"");s.name=g}}return s})}))},U=async e=>{try{let n=e.generator.output?.value||"./prisma/ERD.svg",t=e.generator.config,o=t.theme??"forest",s=d.resolve(d.join(t.mmdcPath||"node_modules/.bin","mmdc")),f=t.tableOnly==="true",$=t.disableEmoji==="true",m=t.ignoreEnums==="true",y=t.includeRelationFromFields==="true",g=process.env.DISABLE_ERD==="true"||t.disabled==="true",b=t.erdDebug==="true"||!!process.env.ERD_DEBUG;if(b&&(console.log("debug mode enabled"),console.log("config",t)),g)return console.log("ERD generator is disabled");let O=Object.values(e.binaryPaths?.queryEngine||{});if(!O[0])throw new Error("no query engine found");let x=O[0],l=p.default.mkdtempSync(`${v.default.tmpdir()+d.sep}prisma-erd-`),i=await k(x,e.datamodel,l);if(!i)throw new Error("could not parse datamodel");if(b&&i){p.default.mkdirSync(d.resolve("prisma/debug"),{recursive:!0});let r=d.resolve("prisma/debug/1-datamodel.json");p.default.writeFileSync(r,i),console.log(`data model written to ${r}`)}let h=JSON.parse(i);if(h.models=_(h.models,e.datamodel),h.types||(h.types=[]),b&&h.models){let r=d.resolve("prisma/debug/2-datamodel-map-applied.json");p.default.writeFileSync(r,JSON.stringify(h,null,2)),console.log(`applied @map to fields written to ${r}`)}let S=W(h,{tableOnly:f,ignoreEnums:m,includeRelationFromFields:y,disableEmoji:$});if(b&&S){let r=d.resolve("prisma/debug/3-mermaid.mmd");p.default.writeFileSync(r,S),console.log(`mermaid written to ${r}`)}if(!S)throw new Error("failed to construct mermaid instance from dml");if(n.endsWith(".md"))return p.default.writeFileSync(n,`\`\`\`mermaid
${S}\`\`\`
`);let E=d.resolve(d.join(l,"prisma.mmd"));p.default.writeFileSync(E,S);let w={deterministicIds:!0,maxTextSize:9e4,er:{useMaxWidth:!0},theme:o},a=w;if(t?.mermaidConfig){let r=await import(d.resolve(t.mermaidConfig));b&&console.log("imported mermaid config: ",r),a={...w,...r}}let c=d.resolve(d.join(l,"config.json"));p.default.writeFileSync(c,JSON.stringify(a));let u=t.puppeteerConfig;if(u&&!p.default.existsSync(u))throw new Error(`Puppeteer config file "${u}" does not exist`);if(!u){let r=d.resolve(d.join(l,"puppeteerConfig.json")),D,L={logLevel:b?"warn":"error",executablePath:D};if(v.default.platform()==="darwin"&&v.default.arch()==="arm64")try{let N=F.execSync("which chromium").toString().replace(`
`,"");if(!N)throw new Error("Could not find chromium executable. Refer to https://github.com/keonik/prisma-erd-generator#issues for next steps.");L.executablePath=N,L.args=["--no-sandbox"]}catch(N){console.error(N),console.log(`
Prisma ERD Generator: Unable to find chromium path for you MacOS arm64 machine. Attempting to use the default at ${D}. To learn more visit https://github.com/keonik/prisma-erd-generator#-arm64-users-
`),D="/usr/bin/chromium-browser"}p.default.writeFileSync(r,JSON.stringify(L)),u=r}if(t.mmdcPath){if(!p.default.existsSync(s))throw new Error(`
Mermaid CLI provided path does not exist. 
${s}`)}else if(!p.default.existsSync(s)){let r=F.execSync("find ../.. -name mmdc").toString().split(`
`).filter(D=>D).pop();if(!r||!p.default.existsSync(r))throw new Error(`Expected mermaid CLI at 
${s}

or
${r}
 but this package was not found.`);s=d.resolve(r)}let M=`"${s}" -i "${E}" -o "${n}" -c "${c}" -p "${u}"`;if(b&&M&&console.log("mermaid command: ",M),F.execSync(M),!p.default.existsSync(n))throw new Error(`Issue generating ER Diagram. Expected ${n} to be created`)}catch(n){throw console.error(n),n}};0&&(module.exports={mapPrismaToDb,parseDatamodel});
